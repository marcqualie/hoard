#!/usr/bin/env php
<?php

// Input Arguments
$api_host = isset($argv[1]) ? $argv[1] : die("Hoard API Host is not set\n");
$bucket_id = isset($argv[2]) ? $argv[2] : die("Hoard BucketID is not set\n");

// HoardUtils Instance (PHP Extension must be installed)
$metrics = new HoardUtils\ServerMetrics();

// Grab data from metrics instance
$data = [
    'load' => $metrics->getLoad(),
    'ncpu' => $metrics->getCpuCount(),
    'memory' => $metrics->getMemoryInfo(),
    'host' => $metrics->getHostName(),
    'processes' => $metrics->getProcessInfo(),
];

// Send data to server
$payload = [
    'name' => 'ping',
    'bucket_id' => $bucket_id,
    'data' => $data,
];
$json_payload = json_encode($payload);
$curl = curl_init();
curl_setopt_array($curl, [
    CURLOPT_URL => $api_host . '/api/events',
    CURLOPT_HEADER => false,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST => true,
    CURLOPT_POSTFIELDS => $json_payload,
    CURLOPT_HTTPHEADER => [
        'Content-Type: application/json',
        'Content-Length: ' . strlen($json_payload)
    ]
]);
$response = curl_exec($curl);
echo $response;
